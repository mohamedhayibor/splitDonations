<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
		<title>Split Donations front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

		<!-- web3.js from: https://github.com/ethereum/web3.js/blob/1.0/dist/web3.min.js -->
		<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  </head>
	<body>
		<!-- create new splitDonation contract section -->
		<div id="createSplitContract" class="jumbotron">
			<div id="txStatus">
				<h2>Split Donations between the organizer and the house.</h2>
				<h3 id="currentContractBalance">Current contract balance: </h3>
			</div>
      		<form>
			  <div class="form-group">
			    <label for="organizerAddress">Organizer's Public address</label>
			    <input type="text" class="form-control" id="organizerAddress" placeholder="Enter Organizer's public address">
			  </div>

			  <div class="form-group">
			    <label for="venueAddress">Venue's Public address</label>
			    <input type="text" class="form-control" id="venueAddress" placeholder="Enter Venue's public address">
			  </div>

			  <button type="submit" class="btn btn-primary" onClick="createSplitContract();">Deploy new SplitDonations contract</button>
			</form>
		</div>

		<!-- donate section -->
		<div id="donate" class="jumbotron">
			<h2>Donate</h2>
			<form>
				<div class="form-group">
				    <label>Contract's address</label>
				    <input type="text" class="form-control" id="donateContractAddress" placeholder="Enter contract's address">
				</div>

				<div class="form-group">
				    <label>Amount to donate</label>
				    <input type="text" class="form-control" id="donationAmount" placeholder="Enter amount to donate in Ether...">
				</div>

				<button type="submit" class="btn btn-primary" onClick="donate();">Donate</button>
			</form>
		</div>


		<!-- Withdraw section -->
		<div id="withdraw" class="jumbotron">
			<h2>Withdraw</h2>
			<form>
				<div class="form-group">
				    <label>Contract's address</label>
				    <input type="text" class="form-control" id="withdrawContractAddress" placeholder="Enter contract's address">
				</div>

				<button type="submit" class="btn btn-primary" onClick="withdraw();">Withdraw donations from contract</button>
			</form>
		</div>

		<script>
			function startApp() {
				var splitDonationsAddress = "0xE50a24D1Bfb94D11df0DF6d226d382ddEb451dEf";

			    var splitContract = web3js.eth.contract([{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"venueAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"currentContractBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"organizerAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"inputs":[{"name":"_organizerAddress","type":"address"},{"name":"_venueAddress","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]);

			    var splitContractInstance = splitContract.at(splitDonationsAddress);

			    // Show contract's current balance
			    splitContractInstance.currentContractBalance.call(function (err, res) {
			    	if (err) {
			    		console.log(">>>> Err: ", err);
			    	} else {
			    		console.log("Successfull call >> view function");
			    		console.log(">>>> Res: ", res);
			    		console.log(">>>> Res.s: ", res.s);
			    		$("#currentContractBalance").text("Current contract balance: >>>" + res.s + " Ether");
			    	}
			    })

			    // address from metamask > startApp() runs again at time of execution
			    // so it will pick up the right current userAddress
			    var userAddress = web3js.eth.accounts[0];

			    function submitDeposit() {
			    	// working somehow > gives 0 amount as donation
			    	splitContractInstance.deposit({from: userAddress, value: 1000000000000000000}, function (err, hash) {
			    		if (err) {
			    			return error(err);
			    		}

			    		waitDepositConfirmation(hash, function() {
			    			console.log("Deposit successfully submitted");

			    		});
			    	})
			    }

			    function waitDepositConfirmation(hash, cb) {
			    	web3js.eth.getTransactionReceipt(hash, function(err, receipt) {
			    		if (err) {
			    			console.log(err);
			    		}

			    		if (receipt !== null) {
			    			// transaction went through
			    			if (cb) {
			    				cb(receipt);
			    			}
			    		} else {
			    			// try again in 1s
			    			window.setTimeout(function () {
			    				waitDepositConfirmation(hash, cb);
			    			}, 1000);
			    		}
			    	})
			    }

			    function createSplitContract() {
			    	var organizerAddress = $("#organizerAddress").val();
			    	var venueAddress = $("#venueAddress").val();

			    	var newContract = splitContract.new(organizerAddress, venueAddress, {
			    		from: userAddress,
			    		data: "0x608060405234801561001057600080fd5b5060405160408061061b83398101806040528101908080519060200190929190805190602001909291905050508073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff1614151515610107576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602d8152602001807f646f6e6174696f6e20616363742063616e2774206265207468652073616d652081526020017f617320686f75736520616363740000000000000000000000000000000000000081525060400191505060405180910390fd5b816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610482806101996000396000f300608060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633ccfd60b1461007d57806341c0e1b51461009457806369ba4f68146100ab578063888f26b814610102578063c373ec8d1461012d578063d0e30db014610184575b600080fd5b34801561008957600080fd5b5061009261018e565b005b3480156100a057600080fd5b506100a96103d1565b005b3480156100b757600080fd5b506100c06103ea565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561010e57600080fd5b50610117610410565b6040518082815260200191505060405180910390f35b34801561013957600080fd5b5061014261042f565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b61018c610454565b005b6000803373ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16148061023957503373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15156102d3576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260218152602001807f596f75277265206e6f7420746865206f776e6572206f72206465706c6f79657281526020017f2e0000000000000000000000000000000000000000000000000000000000000081525060400191505060405180910390fd5b3073ffffffffffffffffffffffffffffffffffffffff163191506002828115156102f957fe5b0490506000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f19350505050158015610363573d6000803e3d6000fd5b50600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f193505050501580156103cc573d6000803e3d6000fd5b505050565b3073ffffffffffffffffffffffffffffffffffffffff16ff5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60003073ffffffffffffffffffffffffffffffffffffffff1631905090565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5600a165627a7a72305820ad1b5d0aabaeaba873d1c6b566800d94ae69fd77424adc22190933ef8831dfe00029",
			    		gas: "4700000"
			    	}, function(err, newContract) {
			    		if (!err) {
			    			// Note: The callback will fire twice!
			    			// Once the contract has the transactionHash property set < and > once its deployed on an address

			    			// e.g. check tx hash on the first call (transaction send)
			    			if (!newContract.address) {
			    				// hash of the transaction which deploys the contract
			    				console.log(">> Transaction hash: ", newContract.transactionHash);
			    				// check address on the second call (contract deployed)
			    			} else {
			    				console.log("deployed address: ", newContract.address);
			    			}
			    		}
			    	});

			    	console.log("executed > created > createSplitContract");
			    	console.log(organizerAddress);
			    	console.log(venueAddress);
			    }

			    // shitty getters

			    console.log("OOOPs called Internal GUTS>>>>>")
			    return {
			    	splitContract: splitContract,
			    	splitContractInstance: splitContractInstance,
			    	splitDonationsAddress: splitDonationsAddress,
			    	userAddress: userAddress,
			    	submitDeposit: submitDeposit,
			    	createSplitContract: createSplitContract
			    }

			}

		    window.addEventListener('load', function() {

			  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
			  if (typeof web3 !== 'undefined') {
			    // Use Mist/MetaMask's provider
			    web3js = new Web3(web3.currentProvider);
			  } else {
			    console.log('No web3? You should consider trying MetaMask!')
			    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
			    web3js = new Web3(new Web3.providers.HttpProvider("https://rinkeby.infura.io/"));
			  }

			  // Now you can start your app & access web3 freely:
			  startApp()
			})


		</script>
  </body>
</html>