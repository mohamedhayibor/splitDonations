<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
		<title>Split Donations front-end</title>
    <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

		<!-- web3.js from: https://github.com/ethereum/web3.js/blob/1.0/dist/web3.min.js -->
		<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
  </head>
	<body>
		<div id="createSplitContract" class="jumbotron">
			<div id="txStatus">
				<h2>Split Donations between the organizer and the house.</h2>
				<h3 id="currentContractBalance">Current contract balance: </h3>
			</div>
      		<form>
			  <div class="form-group">
			    <label for="organizerAddress">Organizer's Public address</label>
			    <input type="text" class="form-control" id="organizerAddress" placeholder="Enter Organizer's public address">
			  </div>

			  <div class="form-group">
			    <label for="venueAddress">Venue's Public address</label>
			    <input type="text" class="form-control" id="venueAddress" placeholder="Enter Venue's public address">
			  </div>

			  <button type="submit" class="btn btn-primary" onClick="createSplitContract();">Deploy new SplitDonations contract</button>
			</form>
		</div>

		<script>
			var splitDonationsAddress = "0xE50a24D1Bfb94D11df0DF6d226d382ddEb451dEf";
			var Web3 = require('web3');
		    var web3 = new Web3();
		    web3.setProvider(new web3.providers.HttpProvider("https://rinkeby.infura.io"));

		    var splitContract = web3.eth.contract([{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"venueAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"currentContractBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"organizerAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"deposit","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"inputs":[{"name":"_organizerAddress","type":"address"},{"name":"_venueAddress","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}]).at(splitDonationsAddress);

		    console.log("splitContract: ", splitContract);

		    splitContract.currentContractBalance.call(function (err, res) {
		    	if (err) {
		    		console.log(">>>> Err: ", err);
		    	} else {
		    		console.log("Successfull call >> view function");
		    		console.log(">>>> Res: ", res);
		    		console.log(">>>> Res.s: ", res.s);
		    		$("#currentContractBalance").text("Current contract balance: >>>" + res.s + " Ether");
		    	}
		    })

	    	web3.version.getNode(function (err, res) {
	    		console.log("getNode Res: ", res);
	    	});

		    console.log("End of party!");

		    function submitDeposit() {
		    	splitContract.deposit.sendTransaction(function (err, hash) {
		    		if (err) {
		    			return error(err);
		    		}

		    		waitDepositConfirmation(hash, function() {
		    			console.log("Deposit successfully submitted");

		    		});
		    	})
		    }

		    function waitDepositConfirmation(hash, cb) {
		    	web3.eth.getTransactionReceipt(hash, function(err, receipt) {
		    		if (err) {
		    			console.log(err);
		    		}

		    		if (receipt !== null) {
		    			// transaction went through
		    			if (cb) {
		    				cb(receipt);
		    			}
		    		} else {
		    			// try again in 1s
		    			window.setTimeout(function () {
		    				waitDepositConfirmation(hash, cb);
		    			}, 1000);
		    		}
		    	})
		    }

		    function createSplitContract() {
		    	var organizerAddress = $("#organizerAddress").val();
		    	var venueAddress = $("#venueAddress").val();
		    	console.log("executed createSplitContract");

		    	// TODO
		    }

		</script>

  </body>
</html>